(function(k,o){typeof exports==="object"&&typeof module!=="undefined"?o(exports):typeof define==="function"&&define.amd?define(["exports"],o):(k=k||self,o(k.Squid={}))})(this,function(k){"use strict";function o(a,b=null,c){const d=(e,f)=>{let h=a.lastIndex,g=a.exec(e);return!f&&a.global&&(a.lastIndex=h),g&&g.length>=2?g[1]:null};return b?d(b,!!c):d}const w=a=>Array.from(a),x=(a,b)=>{typeof a==="string"&&(a=new RegExp(a)),a.global||(a=new RegExp(a,a.flags+"g"));const c=d=>{let e=w(d.matchAll(a));return e.length===0?[]:e.map(f=>f.length===2?f[1]:f.slice(1))};return b!==void 0?c(b):c},J=a=>Object.prototype.toString.call(a),K=a=>a instanceof RegExp,L=a=>J(a)==="[object Object]",M=a=>Array.isArray(a),N=a=>typeof a==="function",O=a=>typeof a==="string",P=a=>a instanceof ArrayBuffer,q=()=>Object.create(null),Q=a=>a instanceof Blob,r=document,y=a=>a.querySelector.bind(a),z=a=>a.querySelectorAll.bind(a),A=(a,b)=>(c,d)=>{let e=b;if(c===null)return null;if(d)if(typeof d==="string"){let f=b(d);e=a(f&&(f==null?void 0:f.length)>0?f[0]:f)}else typeof d==="function"?e=d:e=a(d);return typeof c==="string"?e(c):typeof c==="function"?c:a(c)},s=(a=r)=>{const b=y(a),c=z(a),d=A(y,b),e=A(z,c);return{$:(f,h)=>d(f,h),$$:(f,h)=>e(f,h)}},R=(a,b)=>new Promise(c=>{const d=new FileReader();d.onload=()=>c(d.result),d.readAsText(a,b)}),S=(a,b="GBK",c="")=>(c||(c=Q(a)?"blob":P(a)?"arrayBuffer":""),new Promise((d,e)=>{c==="blob"?d(R(a,b)):c==="arrayBuffer"?d(new TextDecoder(b).decode(a)):e(new Error("未知类型"))})),B=(a,b="utf-8")=>(b=b.toLowerCase(),b==="utf8"||b==="utf-8"?a.text():a.arrayBuffer().then(c=>S(c,b,"arrayBuffer"))),C=(a,b="utf8")=>(typeof a==="string"&&(a=fetch(a)),a instanceof Response?B(a,b):a.then(c=>B(c,b))),T=(a,b="")=>{const c=a.createElement("base");c.href=b,a.head.append(c)},D=(a="",b="")=>{const c=r.implementation.createHTMLDocument();return a&&(c.documentElement.innerHTML=a),b&&T(c,b),c},U=(a,b="")=>{let c,d,e=null,f="";a instanceof Document?(e=a,f=e.documentElement.outerHTML):a instanceof Element?(e=a,f=a.outerHTML):f=a;const h={html:f,$(g,i){return c||({$:c,$$:d}=s(h.doc)),h.$=c,c(g,i)},get doc(){return e===null&&(e=D(f,b)),e},$$(g,i){return d===null&&({$:c,$$:d}=s(h.doc)),h.$$=d,d(g)},matchOne(g,i=!1){return o(g)(f,i)},matchAll(g){return x(g,f)}};return h},t=(a=r,b="")=>{const c=U(a,b);return _(c)},V=async a=>{const b=await C(a);return t(b)},W=a=>M(a),E=(a,b)=>{let{attrs:c,texts:d,keepElem:e}=b,f=c.length;typeof d==="string"&&(d=[d]),d!==null&&(d==null?void 0:d.length)>0&&(f+=1),e&&(f+=1);let h=f>1,g=null;for(let i=0;i<c.length;i++){let j=c[i],m="";j.includes(":")&&([j,m]=j.split(":"));let l=a==null?void 0:a.getAttribute(j);if(c.length===1&&!h&&!m)return l;g===null&&(g=q()),g[m||j]=l}if(d)for(let i=0;i<d.length;i++){let j=d[i],m="textContent",l="$";j.startsWith("$")&&(j=j.slice(1),l="$$",m="innerHTML");let I=a==null?void 0:a[m];if(!h&&(d==null?void 0:d.length)===1&&!j)return I;g=g!=null?g:q(),g[j||l]=I}if(e!==null)if(h)g[e||"&"]=a;else return a;return g},X=a=>{let b=[],c=[],d=null;if(a.includes(",")||a.includes(";")){let e=[];return a.includes(";")?e=a.split(";"):a.includes(",")&&(e=e.concat(a.split(","))),F(e)}else a[0]==="@"?b.push(a.slice(1)):a[0]==="$"?c.push(a.slice(1)):a[0]==="&"?d=a.slice(1):d=a;return{attrs:b,texts:c,elem:d}},F=a=>{let b=[],c=[],d=null;return a.forEach(e=>{let{attrs:f,texts:h,elem:g}=X(e);b=b.concat(f),h.length>0&&(c=c==null?void 0:c.concat(h)),g!==null&&(d=g)}),{attrs:b,texts:c,elem:d}},Y=/{([^}]*)}/g,Z=(a,b)=>{let c=null,d=[],e=[],f=null;if(b.includes("{"))d=x(Y,b),b=b.replace(/{[^}]*}/g,""),{attrs:e,texts:c,elem:f}=F(d);else if(b.endsWith("$"))c="",b=b.slice(0,-1),b.slice(-1)==="$"&&(c="$",b=b.slice(0,-1));else if(b.includes("$")){const i=b.split("$");b=i[0],c=i[1]}else if(b.includes("@")){const i=b.split("@");e.push(i[1]),b=i[0]}else b.endsWith("&")&&(b=b.slice(0,-1));e.length>1&&(e=[...new Set(e)]);let h={attrs:e,texts:c,keepElem:f};if(b.startsWith("||")){b=b.substring(2);let i=a.$$(b);return c===null&&e.length===0?i:i===null?i:w(i).map(j=>E(j,h))}let g=a.$(b);return c===null&&e.length===0||!g?g:E(g,h)},_=a=>{const b=c=>{if(O(c))return Z(a,c);{if(K(c))return a.matchOne(c);{if(N(c))return c(a);if(W(c)){let[e,...f]=c,h=b(e);return f.forEach(g=>h=g(h,a)),h}else{if(c instanceof Element)return t(c);if(L(c)){const e=q();for(let f in c){var d=c[f];e[f]=b(d)}return e}else throw new Error("selector 无法处理")}}}};return b.ctx=a,b.parse=b,b};var n=typeof window==="object"&&window.window===window?window:typeof self==="object"&&self.self===self?self:typeof global==="object"&&global.global===global?global:this;function $(a,b){return typeof b==="undefined"?b={autoBom:!1}:typeof b!=="object"&&(console.warn("Deprecated: Expected third argument to be a object"),b={autoBom:!b}),b.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob([String.fromCharCode(65279),a],{type:a.type}):a}function u(a,b,c){var d=new XMLHttpRequest();d.open("GET",a),d.responseType="blob",d.onload=function(){v(d.response,b,c)},d.onerror=function(){console.error("could not download file")},d.send()}function G(a){var b=new XMLHttpRequest();b.open("HEAD",a,!1);try{b.send()}catch(c){}return b.status>=200&&b.status<=299}function p(a){try{a.dispatchEvent(new MouseEvent("click"))}catch(c){var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(b)}}var H=/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),v=n.saveAs||(typeof window!=="object"||window!==n?function a(){}:"download"in HTMLAnchorElement.prototype&&!H?function a(b,c,d){var e=n.URL||n.webkitURL,f=document.createElement("a");c=c||b.name||"download",f.download=c,f.rel="noopener",typeof b==="string"?(f.href=b,f.origin!==location.origin?G(f.href)?u(b,c,d):p(f,f.target="_blank"):p(f)):(f.href=e.createObjectURL(b),setTimeout(function(){e.revokeObjectURL(f.href)},4e4),setTimeout(function(){p(f)},0))}:"msSaveOrOpenBlob"in navigator?function a(b,c,d){c=c||b.name||"download";if(typeof b==="string")if(G(b))u(b,c,d);else{var e=document.createElement("a");e.href=b,e.target="_blank",setTimeout(function(){p(e)})}else navigator.msSaveOrOpenBlob($(b,d),c)}:function a(b,c,d,e){e=e||open("","_blank"),e&&(e.document.title=e.document.body.innerText="downloading...");if(typeof b==="string")return u(b,c,d);var f=b.type==="application/octet-stream",h=/constructor/i.test(n.HTMLElement)||n.safari,g=/CriOS\/[\d]+/.test(navigator.userAgent);if((g||f&&h||H)&&typeof FileReader!=="undefined"){var i=new FileReader();i.onloadend=function(){var l=i.result;l=g?l:l.replace(/^data:[^;]*;/,"data:attachment/file;"),e?e.location.href=l:location=l,e=null},i.readAsDataURL(b)}else{var j=n.URL||n.webkitURL,m=j.createObjectURL(b);e?e.location=m:location.href=m,e=null,setTimeout(function(){j.revokeObjectURL(m)},4e4)}});const aa=(a="",b="",c="utf8")=>{const d=new Blob([b],{type:"text/plain;charset=utf-8"});v(d,a)};k.Luna=t,k.LunaURL=V,k.Sq=s,k.createDom=D,k.fetchAsText=C,k.saveAs=v,k.saveAsText=aa,Object.defineProperty(k,"__esModule",{value:!0})});
