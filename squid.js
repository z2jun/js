(function(m,k){typeof exports==="object"&&typeof module!=="undefined"?module.exports=k():typeof define==="function"&&define.amd?define(k):(m=m||self,m.Squid=k())})(this,function(){"use strict";function m(a,c=null,b){const d=(e,f)=>{let h=a.lastIndex,g=a.exec(e);return!f&&a.global&&(a.lastIndex=h),g&&g.length>=2?g[1]:null};return c?d(c,!!b):d}const k=a=>Array.from(a),q=(a,c)=>{typeof a==="string"&&(a=new RegExp(a)),a.global||(a=new RegExp(a,a.flags+"g"));const b=d=>{let e=k(d.matchAll(a));return e.length===0?[]:e.map(f=>f.length===2?f[1]:f.slice(1))};return c!==void 0?b(c):b},z=a=>Object.prototype.toString.call(a),A=a=>a instanceof RegExp,B=a=>z(a)==="[object Object]",C=a=>Array.isArray(a),D=a=>typeof a==="function",E=a=>typeof a==="string",o=()=>Object.create(null),p=document,r=a=>a.querySelector.bind(a),s=a=>a.querySelectorAll.bind(a),t=(a,c)=>(b,d)=>{let e=c;if(b===null)return null;if(d)if(typeof d==="string"){let f=c(d);e=a(f&&(f==null?void 0:f.length)>0?f[0]:f)}else typeof d==="function"?e=d:e=a(d);return typeof b==="string"?e(b):typeof b==="function"?b:a(b)},u=(a=p)=>{const c=r(a),b=s(a),d=t(r,c),e=t(s,b);return{$:(f,h)=>d(f,h),$$:(f,h)=>e(f,h)}},F=(a,c="")=>{const b=a.createElement("base");b.href=c,a.head.append(b)},G=(a="",c="")=>{const b=p.implementation.createHTMLDocument();return a&&(b.documentElement.innerHTML=a),c&&F(b,c),b},H=(a,c="")=>{let b,d,e=null,f="";a instanceof Document?(e=a,f=e.documentElement.outerHTML):a instanceof Element?(e=a,f=a.outerHTML):f=a;const h={html:f,$(g,i){return b||({$:b,$$:d}=u(h.doc)),h.$=b,b(g,i)},get doc(){return e===null&&(e=G(f,c)),e},$$(g,i){return d===null&&({$:b,$$:d}=u(h.doc)),h.$$=d,d(g)},matchOne(g,i=!1){return m(g)(f,i)},matchAll(g){return q(g,f)}};return h},v=(a=p,c="")=>{const b=H(a,c);return M(b)},I=a=>C(a),w=(a,c)=>{let{attrs:b,texts:d,keepElem:e}=c,f=b.length;typeof d==="string"&&(d=[d]),d!==null&&(d==null?void 0:d.length)>0&&(f+=1),e&&(f+=1);let h=f>1,g=null;for(let i=0;i<b.length;i++){let j=b[i],l="";j.includes(":")&&([j,l]=j.split(":"));let n=a==null?void 0:a.getAttribute(j);if(b.length===1&&!h&&!l)return n;g===null&&(g=o()),g[l||j]=n}if(d)for(let i=0;i<d.length;i++){let j=d[i],l="textContent",n="$";j.startsWith("$")&&(j=j.slice(1),n="$$",l="innerHTML");let y=a==null?void 0:a[l];if(!h&&(d==null?void 0:d.length)===1&&!j)return y;g=g!=null?g:o(),g[j||n]=y}if(e!==null)if(h)g[e||"&"]=a;else return a;return g},J=a=>{let c=[],b=[],d=null;if(a.includes(",")||a.includes(";")){let e=[];return a.includes(";")?e=a.split(";"):a.includes(",")&&(e=e.concat(a.split(","))),x(e)}else a[0]==="@"?c.push(a.slice(1)):a[0]==="$"?b.push(a.slice(1)):a[0]==="&"?d=a.slice(1):d=a;return{attrs:c,texts:b,elem:d}},x=a=>{let c=[],b=[],d=null;return a.forEach(e=>{let{attrs:f,texts:h,elem:g}=J(e);c=c.concat(f),h.length>0&&(b=b==null?void 0:b.concat(h)),g!==null&&(d=g)}),{attrs:c,texts:b,elem:d}},K=/{([^}]*)}/g,L=(a,c)=>{let b=null,d=[],e=[],f=null;if(c.includes("{"))d=q(K,c),c=c.replace(/{[^}]*}/g,""),{attrs:e,texts:b,elem:f}=x(d);else if(c.endsWith("$"))b="",c=c.slice(0,-1),c.slice(-1)==="$"&&(b="$",c=c.slice(0,-1));else if(c.includes("$")){const i=c.split("$");c=i[0],b=i[1]}else if(c.includes("@")){const i=c.split("@");e.push(i[1]),c=i[0]}else c.endsWith("&")&&(c=c.slice(0,-1));e.length>1&&(e=[...new Set(e)]);let h={attrs:e,texts:b,keepElem:f};if(c.startsWith("||")){c=c.substring(2);let i=a.$$(c);return b===null&&e.length===0?i:i===null?i:k(i).map(j=>w(j,h))}let g=a.$(c);return b===null&&e.length===0||!g?g:w(g,h)},M=a=>{const c=b=>{if(E(b))return L(a,b);{if(A(b))return a.matchOne(b);{if(D(b))return b(a);if(I(b)){let[e,...f]=b,h=c(e);return f.forEach(g=>h=g(h,a)),h}else{if(b instanceof Element)return v(b);if(B(b)){const e=o();for(let f in b){var d=b[f];e[f]=c(d)}return e}else throw new Error("selector 无法处理")}}}};return c.ctx=a,c.parse=c,c};return v});
